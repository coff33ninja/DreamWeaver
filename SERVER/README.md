# DreamWeaver - Server

This directory contains the server application for the DreamWeaver storytelling network. The server acts as the central hub, managing story progression, character interactions, and client connections.

## Features

*   **Centralized Story Management**: Orchestrates the narrative flow and interactions between the narrator and AI characters.
*   **Client Coordination**: Manages registration, health checks, and communication with `CharacterClient` instances.
*   **Gradio Interface**: Provides a web-based UI for:
    *   Narrating the story (speech-to-text input).
    *   Creating and configuring characters (personality, voice, LLM, client assignment).
    *   Generating access tokens for clients.
    *   **Client Configuration Generation**: Provides a mechanism through the Gradio UI to download a pre-configured `.env` file for `CharacterClient` instances, containing necessary connection details (Actor ID, access token, server URL).
    *   Viewing story history.
    *   Managing story checkpoints.
    *   Exporting the story.
*   **FastAPI Backend**: Exposes API endpoints for client communication, dashboard functionality, secure client handshake, and client configuration file downloads.
*   **Enhanced Authentication**: Implements a mutual handshake protocol where clients exchange their primary token for a short-lived session token, enhancing security for ongoing communication.
*   **Dynamic Client Configuration**: Allows administrators to send configuration updates (e.g., TTS settings, log level) to connected clients in real-time via WebSockets.
*   **Dashboard**: Offers a real-time view of connected clients and their statuses.
*   **Database Integration**: Uses SQLite (`dream_weaver.db`) to store persistent data like story content, character configurations, client information, and session tokens.
*   **Flexible TTS Engine**: Supports multiple Text-to-Speech services for the narrator and server-generated audio.
*   **Asynchronous Operations**: Handles long-running tasks asynchronously to maintain UI responsiveness.

## API Endpoints Overview

The server exposes several key API endpoints under its FastAPI backend (default `http://<API_SERVER_HOST>:<API_SERVER_PORT>`):

*   **`/register` (POST)**: Allows clients to register their presence and network details with the server using their primary token.
*   **`/request_handshake_challenge` (POST)**: Allows registered clients to request a security challenge by presenting their primary token. Body: `{"Actor_id": "string", "token": "string"}`. Returns: `{"challenge": "string"}`.
*   **`/submit_handshake_response` (POST)**: Allows clients to submit their computed response to a challenge. Body: `{"Actor_id": "string", "challenge_response": "string"}`. Returns: `{"session_token": "string", "expires_at": "datetime_string"}` on success.
*   **`/get_traits` (GET)**: Fetches character traits for an authenticated client. Requires primary or session token.
*   **`/heartbeat` (POST)**: Allows clients to send heartbeat signals. Requires primary or session token.
*   **`/save_training_data` (POST)**: Allows clients to save LLM training data. Requires primary or session token.
*   **`/get_reference_audio/{filename}` (GET)**: Serves reference audio files. Requires primary or session token. Query params: `Actor_id`, `token`.
*   **`/download_client_config/{actor_id}` (GET)**: Provides a downloadable `.env` configuration file specifically tailored for the specified `actor_id` client. This file contains the client's `CLIENT_Actor_ID` (which is the `{actor_id}` from the path), a unique `CLIENT_TOKEN` (generated by the server), and the `SERVER_URL` (which the client should use to connect back to this server, provided as a query parameter during the download request from Gradio). This helps in easy setup of new `CharacterClient` instances.
*   **`/dashboard/status` (GET)**: Provides data for the live dashboard.
*   **`/dashboard` (GET)**: Serves the HTML dashboard page.
*   **`/ws/{actor_id}` (WebSocket)**: Establishes a persistent WebSocket connection with a client. Requires a valid `session_token` as a query parameter for authentication (e.g., `/ws/Actor2?session_token=xxx`). Used for server-to-client messages like dynamic configuration updates.

(Other internal or less critical endpoints might exist.)

## Gradio Interface

In addition to story narration and character creation, the Gradio UI includes:
*   **Client Setup Assistance (within Character Management Tab)**: The "Client Configuration Download" feature allows an administrator to input the server's externally accessible URL (from the client's perspective) and select a client Actor ID. Clicking 'Download Client .env File' triggers the generation and download of a `.env` file. This file is intended to be placed in the root directory of the corresponding `CharacterClient` and contains `CLIENT_Actor_ID`, `CLIENT_TOKEN`, and `SERVER_URL`.
*   **Dynamic Client Configuration Tab**: Allows selection of an active client (connected via WebSocket) and sending of configuration updates for parameters like TTS settings and client-side log levels.

## Directory Structure

*   **`src/`**: Contains the core server source code.
    *   **`config.py`**: Manages server-specific paths for data, models, checkpoints, and database. Paths are configurable via environment variables.
    *   **`database.py`**: Handles database schema creation and operations.
    *   **`client_manager.py`**: Manages client connections, status updates, and health checks.
    *   **`csm.py`** (Central State Manager): Likely manages the overall state of the story and interactions.
    *   **`character_server.py`**: Implements the logic for "Actor1", the server's own internal character, including its LLM and TTS interactions.
    *   **`gradio_interface.py`**: Implements the Gradio web UI, including character creation, story progression, and client configuration download features.
    *   **`server_api.py`**: Defines FastAPI endpoints for client-server communication (registration, handshake, traits, heartbeat, data saving, audio retrieval) and also includes the endpoint (`/download_client_config/{actor_id}`) responsible for generating downloadable `.env` files for clients.
    *   **`llm_engine.py`**: Manages LLM functionalities for the server (e.g., for Actor1).
    *   **`tts_manager.py`**: Manages TTS functionalities for the server (e.g., for Actor1 and narrator).
    *   **`checkpoint_manager.py`**: Handles saving and loading of story checkpoints, and story export.
    *   **`narrator.py`**: Logic related to processing the narrator's input (e.g., speech-to-text).
    *   **`chaos_engine.py`**: (Purpose to be inferred - might introduce dynamic events or challenges into the story).
    *   **`dashboard.py`**: Contains the FastAPI router and logic for the server's HTML dashboard.
    *   **`env_manager.py`**: Manages the server's *own* environment variables (e.g., for API keys or configurations used by the server itself), typically loaded from a `.env` file located in the `SERVER/` directory. It is not directly involved in generating `.env` files for clients.
    *   **`hardware.py`**: (Purpose to be inferred - might involve hardware monitoring or specific hardware acceleration capabilities for server functions).
    *   **`websocket_manager.py`**: Manages active WebSocket connections with clients, facilitating real-time bidirectional communication (e.g., for sending dynamic configuration updates).
*   **`main.py`**: Entry point for launching the server application, which starts both the Gradio UI and FastAPI backend in separate processes.
*   **`requirements.txt`**: Python dependencies for the server.
*   **`data/`** (Default location, path configurable via `DREAMWEAVER_DATA_PATH` env var):
    *   **`dream_weaver.db`**: SQLite database file.
    *   **`audio/`**: Storage for server-side audio (e.g., narrator recordings, character responses).
    *   **`models/`**: Storage for server-side models (e.g., STT models, narrator TTS models).
*   **`logs/`**: Contains server-side log files (e.g., `server.log`). Useful for debugging and monitoring server activity. (Created automatically within the `SERVER` directory).
*   **`checkpoints/`** (Default location, path configurable via `DREAMWEAVER_CHECKPOINT_PATH` env var): Storage for story checkpoints.
*   **`tests/`**: Contains tests for the server components.

## Logging

The server now implements more structured logging:
*   Logs are output to both the console and a rotating file located at `SERVER/logs/server.log`.
*   Log entries include timestamp, logger name, level, module, and message.
*   This provides better insights into server operations and aids in troubleshooting.

## Setup and Installation

1.  **Prerequisites:**
    *   Python 3.9+
    *   Git (if cloning from the DreamWeaver repository)
    *   An NVIDIA GPU with CUDA is recommended for optimal performance if using local LLMs/TTS on the server.

2.  **Clone the Repository (if not already done):**
    ```bash
    git clone <your_repo_url>
    cd DreamWeaver/SERVER
    ```

3.  **Install Dependencies:**
    Navigate to the `SERVER` directory and install the required Python packages:
    ```bash
    pip install -r requirements.txt
    ```
    You may need to install system dependencies for some functionalities (e.g., CUDA toolkits for GPU support).

4.  **Configuration (Environment Variables):**
    It's recommended to configure the server using environment variables. You can create a `.env` file in the `DreamWeaver/SERVER/` directory or set them system-wide.
    *   `DREAMWEAVER_DATA_PATH`: Base path for all server-related data files.
        *   Default: `[ProjectRoot]/data/` (i.e., `DreamWeaver/data/`)
    *   `DB_PATH`: Full path to the `dream_weaver.db` SQLite database file.
        *   Default: `[DREAMWEAVER_DATA_PATH]/dream_weaver.db`
    *   `DREAMWEAVER_MODEL_PATH`: Path for storing server-specific models (LLM, TTS, STT).
        *   Default: `[DREAMWEAVER_DATA_PATH]/models/`
    *   `DREAMWEAVER_CHECKPOINT_PATH`: Path for storing story checkpoints.
        *   Default: `[ProjectRoot]/checkpoints/`
    *   `GRADIO_SERVER_NAME`: Host for the Gradio UI.
        *   Default: `127.0.0.1` (localhost)
    *   `GRADIO_SERVER_PORT`: Port for the Gradio UI.
        *   Default: `7860`
    *   `API_SERVER_HOST`: Host for the FastAPI backend.
        *   Default: `0.0.0.0` (accessible from network)
    *   `API_SERVER_PORT`: Port for the FastAPI backend.
        *   Default: `8000`

5.  **Launch the Server:**
    From the root directory of the DreamWeaver project (`DreamWeaver/`):
    ```bash
    python SERVER/main.py
    ```
    Or, if you are already in the `DreamWeaver/SERVER/` directory:
    ```bash
    python main.py
    ```

    *   The Gradio UI should then be accessible at `http://<GRADIO_SERVER_NAME>:<GRADIO_SERVER_PORT>` (e.g., `http://127.0.0.1:7860`).
    *   The FastAPI backend (and dashboard) will be available at `http://<API_SERVER_HOST>:<API_SERVER_PORT>` (e.g., `http://0.0.0.0:8000`, with the dashboard likely at `/dashboard`).

## Operation

Once launched, the server will:
1.  Initialize its database if it doesn't exist.
2.  Start the FastAPI backend to listen for client registrations and API calls.
3.  Launch the Gradio web interface for narrator interaction and system management.
4.  Be ready to accept connections from `CharacterClient` instances.
5.  Manage the story progression based on narrator input and character responses.

Refer to the main project README for details on the overall DreamWeaver system architecture and `CharacterClient` setup.
